{% extends "base.html" %}

{% block style %}
<style>
    
    .query:hover {
      cursor: pointer; /* Change cursor to pointer (hand) */
      text-decoration: underline; /* Add underline */
    }
    .query {
      font-size:min(3.5vmin,2.5vh);
    }
    .content-initial{
      font-size:min(3vmin,2vh);
      padding-left:2%;
      padding-right:2%;
      display: -webkit-box;
      -webkit-line-clamp: 2; /* Number of lines to show */
      -webkit-box-orient: vertical;
      overflow-y:hidden;
      word-wrap: break-word; /* Ensures long words break and wrap to the next line */
      word-break: break-all;
      cursor:pointer;
    }
    .content{
      font-size:min(3vmin,2vh);
      padding-left:2%;
      padding-right:2%;
      word-wrap: break-word; /* Ensures long words break and wrap to the next line */
      word-break: break-all;
    }
    
    .content-final {
      font-size:min(3vmin,2vh);
      padding-left:2%;
      padding-right:2%;
      display: -webkit-box;
      -webkit-line-clamp: 2; /* Number of lines to show */
      -webkit-box-orient: vertical;
      overflow-y:hidden;cursor:pointer;
    }
</style>

{% endblock style %}

{% block body %}
<div class="container-fluid p-0">
    <div class="d-flex justify-content-between flex-parent " >
        <div class="flex-right flex-fill container" style="position: fixed;min-width:20%">
          <div class="container" >
            <inline class="cat-info align-text-bottom m-0">
              <p style="color:#BF7497;  font-weight: bold; 
              font-size:min(4vmin,3vh);">Categories</p>
            </inline>
            {% for cat in categories %}
              <div class="cat-info toggleclasses dark">
                <img src="{{cat.image.url}}" alt="">
                <span>{{cat.name}}</span>
              </div>
            {% endfor %}
          </div>
        </div>
        <div  class="flex-center flex-fill "style="flex-direction:column" style="overflow-y:auto;">
          <div  id="post-container">
            
          </div>
          <div class="container-fluid mb-3"id="post-loader">  
            <img src="/static/post_loader.gif" >
          <div>
        </div>
        <div class="flex-left flex-fill" style="width:20%">
        </div>
        
    </div>
</div>


{% endblock body %}

{% block script %}
<script>
  function show_content(post_id){
    $('#content-final'+post_id).css('display','flex')
  }
</script>

<script>
  const maxHeight = 150;

  function showMoreButton(post_id){
    $('#content'+post_id).css({'max-height':'none'}),
    $('#showMoreButton'+post_id).hide(),
    $('#showLessButton'+post_id).show(),
    $('#content-initial'+post_id).css('display','none'),
    $('#content-final'+post_id).css('display','flex')

    //button_positioning(post_id);
  }

</script>

<script>
  let offset=0
  let limit=3
  let posts_available=true

  function LoadPost(){
    console.log(offset)
      $.ajax({
      url:'/fetch_post',
      data: {'offset':offset},
      success:function(data){
        $('#post-loader').hide()
        console.log('SuccessFul!!!!!')
        console.log(data)
        const posts = data.posts
        let postHTML=``
        var darkModeStatus = localStorage.getItem('darkMode');
        var dark_light = (darkModeStatus==='enabled')? 'dark':'';
        for(const post of posts){
          var content = post.content.replace(/\n/g, '<br>');
          let postHTML=
          `<div class="container-fluid mb-3">
            <div class="outer-post-block toggleclasses ${dark_light} pb-0"  style="z-index:100; position:relative">
                <div class="post-block" id="content${post.id}" >
                  <div class="user-info">
                    <img src="${post.avatar} " alt="User Image">
                    <div class="d-flex" style="flex-direction:column">
                    <a href="/profile/${post.id}"><span style="font-weight: bold; font-size:1.2vmax">${post.username}</span></a>
                    <p style="font-size:50%">${post.time}</p>
                    </div>
                  </div>
                  <a href="post_page/${post.id}">
                  <div class="query mx-2" >
                    ${post.query}
                  </div>
                  </a>`;
          if(post.image){
                  postHTML+=  
                  `<div class="content-initial my-1"style=" line-height: 1.5;" id="content-initial${post.id}">
                    ${post.content}
                  </div>
                  <div class="post-img toggleclasses ${dark_light}">
                    <img class="" src="${post.image} " >
                  </div>`
          }else{
                  postHTML+=
                  `<div class="content-final" style="line-height: 1.5" id="content-final${post.id}" onclick="show_content(${post.id})">
                    ${content}
                  </div>`
          };
          postHTML +=        
          `<div class="content"style="line-height: 1.5;display:none" id="content-final${post.id}">
            ${content}
          </div></div>`
          if(post.image){
                  postHTML+= 
                `<div class="container overlap-div" id="post-button${post.id}">
                  <div class="text-center">
                      <button class="post-button" id="showMoreButton${post.id}" onclick="showMoreButton(${post.id})">Show More v</button>
                  </div>
                </div>`
          }
          postHTML+=
              `</div>
            </div>`
          
          $('#post-container').append(postHTML)
        }
        offset +=limit
        if(posts.length===0){
          $('#post-loader').show()
          $('#post-loader').html("Please Reload!!!")
          posts_available=false
        }
      },
    })
  }

  $(document).ready(function(){
    LoadPost()
    $(window).scroll(function(){
      if(posts_available){
        let scroo=$(window).height()+$(window).scrollTop()
        console.log($(document).height()+'  '+scroo)
        if($(window).scrollTop()+$(window).height()>=$(document).height()-1){
          
          $('#post-loader').show()
          setTimeout(function(){
            LoadPost()},100)
      }}
    })
  })
</script>

{% endblock script %}