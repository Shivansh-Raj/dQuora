{% extends "base.html" %}

{% block style %}
<style>
    .profile-sidebar {
        position:fixed;
        top : 100px;
        width: 20vw;
        height: 75vh;
        background-color: #ffffff;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        padding: 2.5vw;
        box-sizing: border-box;
        position: sticky;
        transition: background-color 1s, color 1s;
    }
    .profile-sidebar img {
        width:min(10vmin,10vh);
        height:min(10vmin,10vh);
        border-radius: 50%;
        display: block;
        margin: 0 auto 20px;
    }
    .profile-sidebar h2 {
        font-size:min(4vmin,4vh);
        margin-bottom: 20px;
    }
    .profile-sidebar p {
        margin: 10px 0;
        font-size:min(2vmin,2vh);
        color: #555;
        transition: color 0.3s;
        overflow-y:auto;
    }
    .profile-sidebar .social-links a {
        margin: 0 5px;
        color: #007bff;
        transition: color 0.3s;
    }
    .profile-content {
        width: 70vw;
        padding: 2.5vw;
        box-sizing: border-box;
        transition: background-color 1s, color 1s;
    }
    .post {
        background-color: #ffffff;
        margin-bottom: 20px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        transition: background-color 1s, color 1s;
    }
    .post h3 {
        margin-top: 0;
    }
    .post-buttons {
        margin-top: 15px;
    }
    .dark {
        background-color: #121212;
        color: #e0e0e0;
    }
    .dark .profile-sidebar {
        background-color: #1e1e1e;
        color: #e0e0e0;
    }
    .dark .profile-sidebar p {
        color: #cfcfcf;
    }
    .dark .profile-sidebar .social-links a {
        color: #bb86fc;
    }
    .dark .post {
        background-color: #1e1e1e;
        color: #e0e0e0;
    }
    .btn-primary{
        margin : 2%;

    }

    .dark .btn-primary {
        background-color: #bb86fc;
        border-color: #bb86fc;
    }
    .dark .btn-danger {
        background-color: #cf6679;
        border-color: #cf6679;
    }

    {% comment %} post css {% endcomment %}
    .query {
        font-size:min(4.5vmin,3.5vh);
        padding:2%;
      }
    .content{
        font-size:min(3.5vmin,2.5vh);

    }
    .post-img{
        text-align:center;
        margin-bottom:2%;
    }
    .post-img img{
        width:45%;
        transition: width 0.3s ease;
    }
    .post-img-full{

    }
    .post-img-full img{
        width:100%;
        transition: width 0.3s ease;
    }
    .post-block{
        max-height:none ;
    }
      .query {
        font-size:min(3.5vmin,2.5vh);
      }
      .content{
        font-size:min(3vmin,2vh);
        padding-left:12px;
        padding-left:2%;
        padding-right:2%;
        word-wrap: break-word; /* Ensures long words break and wrap to the next line */
        word-break: break-all;
      }
    
</style>
{% endblock style %}


{% block body %}

<div class="d-flex">
    <div class="profile-sidebar">
        <img src="{{user.avatar}}" alt="Profile Picture" class="img-fluid">
        <h2>{{user.username}}</h2>
        <p><strong>Email:</strong> {{user.email}}</p>
        <p><strong>Password:</strong> ••••••••</p>
        <p><strong>Bio:</strong> {{user.bio}}</p>
        <p><strong>Joined:</strong> {{user.joined|date}}</p>
        <div class="social-links text-center">
            <a href="#"><i class="fab fa-twitter"></i></a>
            <a href="#"><i class="fab fa-linkedin"></i></a>
            <a href="#"><i class="fab fa-github"></i></a>
        </div>
    </div>
    <div class="profile-content">
        {% comment %} {% for post in posts %}
        <div class="post">
            <h3>{{post.query}}</h3>
            <p>{{post.content}}</p>
            <div class="post-buttons">
                <button class="btn btn-sm btn-primary">Modify</button>
                <button class="btn btn-sm btn-danger">Delete</button>
            </div>
        </div>
        {% endfor %} {% endcomment %}
        <div  id="post-container">
            {% for post in posts %}
              <div class="container-fluid mb-3" id="post-container-{{post.id}}">
                <div class="outer-post-block toggleclasses dark pb-0"  style="z-index:100; position:relative">
                    {% if requested_id != request.user.id %}
                      <div class="user-info">
                        <img src="{{post.user_name.avatar}}" alt="User Image">
                        <div class="d-flex" style="flex-direction:column">
                        <a href="/profile/{{post.user_name.id}}"><span style="font-weight: bold; font-size:1.2vmax">{{post.user_name}}</span></a>
                        <p style="font-size:min(2vmin,1vh);">{{post.time|date}}</p>
                        </div>
                      </div>
                    {% endif %}
                  <div class="post-block" id="content{{post.id}}" >
                    <a href="post_page/{{post.id}}">
                    <div class="query" >
                      {{post.query}}
                    </div>
                    </a>  
                    {% if post.image %}
                      <div class="post-img toggleclasses dark" id="post-img">
                        <img class="" src="{{post.image.url}}">
                      </div>
                    {% endif %}
                    <div class="content"style="line-height: 1.5" id="content-final{{post.id}}">
                      {{post.content|linebreaksbr}}
                    </div>
                  </div>
                  <div class="post-buttons" >
                    {% if perms.quora.delete_post and requested_id == request.user.id %}
                      <button class="btn btn-sm btn-primary" onclick="showModificationPopup({{post.id}})">Modify</button>
                      <button class="btn btn-sm btn-danger" id="post-delete{{post.id}}" onclick="delete_post({{post.id}})">Delete</button>
                    {% endif %}
                  </div>

                </div>
              </div>
            {% endfor %}
        </div>
    </div>
</div>


<div class="loader-container-popup " style='display:none'id="modification-popup" >
    <div class="popup "> 
      <button class="close-button" onclick="closePopupBox()">✖</button>
        <div class="popup-content">
          <form id="modification-form" enctype="multipart/form-data">
            <div class="dropdown">
            </div>
            <img src="{{user.avatar}}" class="popup-image">
            <input name="user_name" value="{{user.id}}"  type="hidden">
            <input class="popup-text" name="query" placeholder="Your QUERY goes here!" id="query-modify-input" required></input>
            <textarea class="popup-text-2" name="content" placeholder="Query's content!" id="myTextarea"></textarea>
            <p id="charCount" style="font-size:min(3vmin,2vh);">Character Count: 0/500 </p>
            <div class="d-flex" >
              <div class="custom-file-input d-flex">
                <!-- Custom button to trigger file selection dialog -->
                <button class="post-popup-img" onclick="document.getElementById('imageInput').click();"><img src="/static/image-gallery.png" ></button>
                <!-- Actual file input -->
                <input type="file" id="imageInput" name="image" accept="image/*">
                <p class="selected-file" id="selectedFile"></p>
              </div>
              <button class="popup-submit" id="form-submit-btn" type="submit">Confirm</button>
            </div>
          </form>
        </div>
    </div>
  </div>

  {% comment %} fetched POSTS {% endcomment %}
  <ul id="postList" style="display:none">
    {% for post in posts %}
        <li data-post-id="query-{{ post.id }}">{{ post.query }}</li>
        <li data-post-id="content-{{ post.id }}">{{ post.content }}</li>
    {% endfor %}
  </ul>
{% endblock body %}

{% block script %}

<!-- Bootstrap JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

{% comment %} Delete {% endcomment %}
<script>
    function toast_diaplay(message) {
        $('.toast-body').text(message)
        $('#myToast').toast('show');
    };
    function delete_post(post_id){
        $.ajax({
            url:'/delete_post/'+post_id,
            method:'DELETE',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            success:function(data){
                message=data.message
                toast_diaplay(message)
                if(data.deleted){
                    $('#post-container-'+post_id).text('This post was deleted!!').css('color','red');
                }
            }
        })
    }
</script>

{% comment %} Modify {% endcomment %}

<script>
    function showModificationPopup(post_id){
      localStorage.setItem('item_to_modify', post_id);
      $('#modification-popup').css('display','flex')
      var postQuery = $('#postList li[data-post-id="query-' + post_id + '"]').text();
      var postContent = $('#postList li[data-post-id="content-' + post_id + '"]').text();
      console.log(postQuery)
      $('#query-modify-input').val(postQuery)
      $('#myTextarea').val(postContent)
    }
</script>
<script>
    $(document).ready(function() {
        $('#modification-form').on('submit', function(event) {
            event.preventDefault(); // Prevent default form submission
            
            var post_id = localStorage.getItem('item_to_modify');
            console.log(post_id)
            var formData = new FormData(this);
            console.log(formData)
            
            $.ajax({
                url: '/modify_post/' + post_id, // Fix the variable name
                method: 'POST',
                data: formData,
                processData: false, // Prevent jQuery from transforming the data into a query string
                contentType: false, // Necessary for file upload
                headers: {
                    'X-CSRFToken': getCSRFToken() // Set the CSRF token header
                },
                success: function(data) {
                    var message = data.message;
                    toast_display(message); // Correct the function name
                },
                error: function(xhr, status, error) {
                    console.error('Error modifying post:', status, error);
                    toast_display('Error modifying post.'); // Correct the function name
                }
            });
        });
    
        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }
    
        function toast_display(message) {
            $('.toast-body').text(message);
            $('#myToast').toast({ delay: 3000 });
            $('#myToast').toast('show');
        }
    });
</script>


<script>
    $('#post-img').click(function(){
        $(this).toggleClass('post-img post-img-full')
      })
<script>
{% endblock script %}